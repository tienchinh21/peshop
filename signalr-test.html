<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SignalR JWT Tester</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
    input, button { width: 100%; margin: 5px 0; }
    #log { height: 220px; border: 1px solid #ccc; padding: 5px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>SignalR + JWT Online Tester</h2>

  <label>Hub URL:</label>
  <input id="hubUrl" value="https://tandat.site/dotnet-peshop/hubs/notification" />

  <label>Access Token (JWT):</label>
  <input id="token" type="text" placeholder="Nhập JWT access token..." />

  <label>Type (query):</label>
  <input id="type" type="text" placeholder="Nhập type..." />

  <button id="btnConnect">Connect</button>
  <button id="btnDisconnect" disabled>Disconnect</button>

  <h3>Log</h3>
  <div id="log"></div>

  <!-- SignalR client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
  <script>
    let connection = null;

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('log');
      logDiv.textContent += `[${time}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Connect button
    document.getElementById('btnConnect').onclick = async () => {
      const hubUrl = document.getElementById('hubUrl').value.trim();
      const rawToken = document.getElementById('token').value.trim();
      const type = document.getElementById('type').value.trim();

      if (!hubUrl) return alert('Nhập Hub URL!');
      if (!rawToken) return alert('Nhập JWT token!');

      // Thêm type vào query string nếu có
      let finalUrl = hubUrl;
      if (type) {
        const separator = hubUrl.includes('?') ? '&' : '?';
        finalUrl = `${hubUrl}${separator}type=${encodeURIComponent(type)}`;
      }

      log("Connecting to: " + finalUrl);

      connection = new signalR.HubConnectionBuilder()
        .withUrl(finalUrl, {
          accessTokenFactory: () => rawToken // QUAN TRỌNG: chỉ trả token, không có Bearer
        })
        .withAutomaticReconnect()
        .build();

      connection.on("Message", (message) => {
        log("Message: " + message);
      });

      connection.onclose(err => {
        log('Disconnected: ' + (err?.message || ''));
        document.getElementById('btnConnect').disabled = false;
        document.getElementById('btnDisconnect').disabled = true;
      });

      try {
        await connection.start();
        log('Connected! Token sent.');
        document.getElementById('btnConnect').disabled = true;
        document.getElementById('btnDisconnect').disabled = false;
      } catch (err) {
        log('Connect error: ' + err);
      }
    };

    // Disconnect button
    document.getElementById('btnDisconnect').onclick = async () => {
      if (connection) await connection.stop();
      log("Disconnected manually.");
    };

    
  </script>
</body>
</html>
